CVE-2010-1190: security bypass

http://www.cvedetails.com/cve/CVE-2010-1190/

thumb.php in MediaWiki before 1.15.2, when used with access-restriction
mechanisms such as img_auth.php, does not check user permissions before
providing scaled images, which allows remote attackers to bypass intended access
restrictions and read private images via unspecified manipulations.

-----
taesoo@pc:~/tmp/.../test/mediawiki :)$ diff -u mediawiki-1.15.1/thumb.php mediawiki-1.15.2/thumb.php
--- mediawiki-1.15.1/thumb.php	2008-12-01 12:14:30.000000000 -0500
+++ mediawiki-1.15.2/thumb.php	2010-03-08 17:49:14.000000000 -0500
@@ -20,6 +20,9 @@
 
 function wfThumbMain() {
 	wfProfileIn( __METHOD__ );
+
+	$headers = array();
+
 	// Get input parameters
 	if ( get_magic_quotes_gpc() ) {
 		$params = array_map( 'stripslashes', $_REQUEST );
@@ -65,6 +68,17 @@
 		$img = wfLocalFile( $fileName );
 	}
 
+	// Check permissions if there are read restrictions
+	if ( !in_array( 'read', User::getGroupPermissions( array( '*' ) ), true ) ) {
+		if ( !$img->getTitle()->userCanRead() ) {
+			wfThumbError( 403, 'Access denied. You do not have permission to access ' . 
+				'the source file.' );
+			return;
+		}
+		$headers[] = 'Cache-Control: private';
+		$headers[] = 'Vary: Cookie';
+	}
+
 	if ( !$img ) {
 		wfThumbError( 404, wfMsg( 'badtitletext' ) );
 		return;
@@ -101,7 +115,7 @@
 			$thumbPath = $img->getThumbPath( $thumbName );
 
 			if ( is_file( $thumbPath ) ) {
-				wfStreamFile( $thumbPath );
+				wfStreamFile( $thumbPath, $headers );
 				return;
 			}
 		}
@@ -128,7 +142,7 @@
 		$errorMsg = wfMsgHtml( 'thumbnail_error', 'Image was not scaled, ' .
 			'is the requested width bigger than the source?' );
 	} else {
-		wfStreamFile( $thumb->getPath() );
+		wfStreamFile( $thumb->getPath(), $headers );
 	}
 	if ( $errorMsg !== false ) {
 		wfThumbError( 500, $errorMsg );
@@ -143,6 +157,9 @@
 	header( 'Content-Type: text/html; charset=utf-8' );
 	if ( $status == 404 ) {
 		header( 'HTTP/1.1 404 Not found' );
+	} elseif ( $status == 403 ) {
+		header( 'HTTP/1.1 403 Forbidden' );
+		header( 'Vary: Cookie' );
 	} else {
 		header( 'HTTP/1.1 500 Internal server error' );
 	}


----
1. enable image uploader: in LocalSettings.php
   $wgEnableUploads  = true;
2. increase memory limit   
   $wgMaxShellMemory = 524288;
3. login as admin/admin1234
4. upload image: example.jpg
5. prevent anonymous user can't see it: in LocalSettings.php
   $wgGroupPermissions['*']['read'] = false;
   $wgWhitelistRead = array( "Special:Userlogin", "Help:Contents");
   ref) http://www.mediawiki.org/wiki/Manual:Preventing_access
6. logout (you can't access any pages)
7. but we can still see the (scaled) image through this url:
   http://localhost:8888/thumb.php?f=example.jpg&width=100